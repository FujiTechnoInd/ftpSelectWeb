<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTP選定ツール</title>
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Interフォントの読み込み --><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- ★ 追加: Chart.js CDN --><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Interフォントをデフォルトに設定 */
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background-color: #f1f5f9; /* bg-slate-100 */
        }

        /* カスタムカラー */
        /* 1A (LightBlue) */
        .bg-pump-lightBlue { background-color: #add8e6; } 
        .text-pump-lightBlue { color: #00008b; }
        .border-pump-lightBlue { border-color: #9ac9db; }
        .ring-pump-lightBlue { --tw-ring-color: #add8e6; }

        /* 1RA (Lighter Blue) */
        .bg-pump-lighterBlue { background-color: #cce7ff; }
        .text-pump-lighterBlue { color: #0056b3; }
        .border-pump-lighterBlue { border-color: #bbddff; }
        .ring-pump-lighterBlue { --tw-ring-color: #cce7ff; }

        /* 2A (LightGreen) */
        .bg-pump-lightGreen { background-color: #90ee90; }
        .text-pump-lightGreen { color: #006400; }
        .border-pump-lightGreen { border-color: #80d980; }
        .ring-pump-lightGreen { --tw-ring-color: #90ee90; }

        /* 3F (Purple) */
        .bg-pump-purple { background-color: #d8b4fe; } 
        .text-pump-purple { color: #581c87; } 
        .border-pump-purple { border-color: #c084fc; } 
        .ring-pump-purple { --tw-ring-color: #d8b4fe; }

        /* 3H (Blue) */
        .bg-pump-blue { background-color: #2563eb; } 
        .text-pump-blue { color: #ffffff; } 
        .border-pump-blue { border-color: #1d4ed8; } 
        .ring-pump-blue { --tw-ring-color: #2563eb; }
        
        /* --- 製品選択行のスタイル --- */
        
        .capacity-column {
            display: flex;
            flex-direction: row; 
            align-items: stretch;
            transition: all 0.4s ease-in-out;
            overflow: hidden; 
            flex-grow: 1;
            max-height: 10rem; 
            flex-wrap: nowrap; 
        }
        
        .capacity-column.column-active {
             flex-direction: row; 
             flex-wrap: wrap;
             max-height: 4000px; /* 十分な高さを確保 */
        }

        .product-button-wrapper {
            width: 20rem; 
            cursor: pointer;
            transition: all 0.4s ease-in-out;
            flex-shrink: 0; 
        }
        
        .capacity-column:not(.column-active) .product-button-wrapper {
             width: 20rem;
        }


        .product-button {
            transition: all 0.4s ease-in-out;
            position: relative;
            height: 6rem; /* h-24 */
            overflow: hidden;
            width: 100%;
            display: block;
            border: 4px solid transparent;
        }
        .product-button span {
            transition: all 0.4s ease-in-out;
        }
        
        .capacity-column.column-active .product-button {
            border-color: var(--tw-ring-color); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .capacity-bar-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem; 
            background-color: transparent; 
            transition: opacity 0.3s ease, max-height 0.5s ease; 
            opacity: 1;
            max-height: 200px;
        }
        
        .capacity-bar-fill {
            height: 2.5rem; /* h-10 */
            background-image: linear-gradient(to right, #93c5fd, #2563eb); 
            border-radius: 0.5rem; /* rounded-lg */
            flex-shrink: 0; 
            transition: width 0.5s ease-out;
        }
        .capacity-spec-text {
            padding-left: 0.75rem; /* pl-3 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            color: #1f2937; /* text-gray-800 */
            white-space: nowrap;
        }

        /* スペックバーの非表示 */
        .capacity-column.column-active .capacity-bar-container,
        #product-container.has-active .capacity-column:not(.column-active) .capacity-bar-container {
            display: none;
        }
        
        #product-container:not(.has-active) .capacity-column .capacity-bar-container {
            display: flex;
        }


        /* (グラフ・オプションの縦積みコンテナ) */
        .new-menu-item {
            display: none; 
            background-color: #f8fafc; /* bg-slate-50 */
            animation: fadeIn 0.5s ease 0.3s forwards; 
            opacity: 0;
            max-height: 0; 
            transition: max-height 0.4s ease-in-out; 
            
            flex-grow: 1; 
            width: auto;
        }
         
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .capacity-column.column-active .new-menu-item {
            display: flex; 
            flex-direction: column; 
            max-height: 2000px; 
        }

        /* グラフエリアとオプションエリアの基本スタイル */
        .graphs-area-wrapper,
        .options-area-wrapper {
            display: block; 
            width: 100%; 
        }

        /* オプションタイトルのセンタリング */
        .options-area-wrapper h3 {
            text-align: center;
        }
        
        /* 1RA (オプション無し) の場合の特別対応 */
        .capacity-column.has-options-false.column-active .new-menu-item {
            justify-content: center; /* 縦中央揃え */
        }
        .capacity-column.has-options-false.column-active .options-area-wrapper {
            display: none; /* 非表示 */
        }

        
        /* 写真の拡大・縮小アニメーション */

        /* アクティブな写真 */
        .capacity-column.column-active .product-button {
            height: 30rem; /* h-120 */
        }
        
        .capacity-column.column-active .product-button-wrapper {
            width: 30rem; /* w-80 */
        }


        /* 非アクティブなカラムは非表示 */
        #product-container.has-active .capacity-column:not(.column-active) {
            max-height: 0;
            opacity: 0;
            border-bottom-width: 0;
        }
        
        /* グラフコンテナのスタイル */
        .chart-wrapper {
            width: 100%;
            height: auto;
            position: relative; 
        }
        /* グラフタイトル (Canvas/SVG共通) */
        .chart-title {
            position: absolute;
            top: 0.5rem; 
            left: 0;
            right: 0;
            text-align: center;
            font-size: 1rem; 
            font-weight: 600; 
            color: #4b5563; 
            pointer-events: none; 
        }
        
        /* SVGグラフのスタイル */
         .svg-chart {
             width: 100%;
             height: auto;
             min-height: 250px; 
             background-color: #fff;
         }
         /* SVGエリアのスタイル */
         .svg-chart-area {
             cursor: pointer;
             transition: all 0.2s;
             stroke: #9ca3af; /* デフォルトの枠線 */
             stroke-width: 1;
         }
         .svg-chart-area:hover {
             opacity: 0.8;
         }
         /* SVGエリアのアクティブスタイル */
         .svg-chart-area.active {
             stroke: #3b82f6; /* border-blue-500 */
             stroke-width: 4; /* 太い枠線 */
             fill-opacity: 0.4;
         }

         /* SVG折れ線グラフのスタイル (詳細グラフ用) */
         .svg-chart-line {
            fill: none;
            stroke-width: 1.5;
            transition: all 0.2s;
         }
         .svg-chart-line.dimmed {
             opacity: 0.3;
         }
         .svg-chart-line.highlighted {
             stroke-width: 4;
         }


         /* SVG内テキストのフォントサイズ */
         .svg-chart-text {
             font-family: 'Inter', sans-serif;
             font-weight: 600;
             font-size: 20px; 
             fill: #1f2937;
             pointer-events: none; 
         }
         
         /* オプションボタンのスタイル */
         .option-button {
             padding: 0.75rem 1rem;
             border-radius: 0.5rem;
             background-color: #ffffff;
             border: 1px solid #e2e8f0; /* border-slate-200 */
             box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
             transition: all 0.2s ease-in-out;
             text-align: center;
             font-weight: 500;
             cursor: pointer;
             white-space: nowrap; /* テキストが改行されないように */
         }
         .option-button:hover {
             background-color: #f8fafc; /* bg-slate-50 */
             border-color: #cbd5e1; /* border-slate-300 */
         }
         .option-button:disabled {
             background-color: #e2e8f0; /* bg-slate-200 */
             opacity: 0.7;
             cursor: not-allowed;
         }
         .option-button.active {
             background-color: #dbeafe; /* bg-blue-100 */
             border-color: #3b82f6; /* border-blue-500 */
             color: #1e40af; /* text-blue-800 */
             font-weight: 600;
         }
         .sub-options-container {
             background-color: #f1f5f9; /* bg-slate-100 */
             border-radius: 0.5rem;
             padding: 0.75rem;
             display: flex; /* サブオプションも横並びにするため */
             gap: 0.5rem;
             flex-wrap: wrap;
         }

        /* 製品詳細コンテナ */
        .product-details-container {
            width: 100%;
            flex-basis: 100%; /* 強制的に改行 */
            padding: 1.5rem;
            background-color: #ffffff; /* bg-white */
            border-top: 1px solid #e2e8f0; /* border-slate-200 */
            display: none; /* JSでトグル */
            animation: fadeIn 0.5s ease forwards;
        }
        .product-details-container h2 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
            color: #1e293b; /* text-slate-800 */
            margin-bottom: 1rem;
            border-bottom: 2px solid #3b82f6; /* border-blue-500 */
            padding-bottom: 0.5rem;
        }
        .product-details-container h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #334155; /* text-slate-700 */
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        
        /* 仕様表スタイル */
        .spec-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem; /* text-sm */
        }
        .spec-table th, .spec-table td {
            border: 1px solid #cbd5e1; /* border-slate-300 */
            padding: 0.75rem;
            text-align: center;
        }
        .spec-table th {
            background-color: #f1f5f9; /* bg-slate-100 */
            font-weight: 600;
            white-space: nowrap;
        }
        .spec-table td {
            background-color: #ffffff;
        }
        .spec-table .highlight {
            background-color: #fef9c3; /* bg-yellow-100 */
            font-weight: 700;
        }
        .spec-table-note {
            font-size: 0.75rem; /* text-xs */
            color: #475569; /* text-slate-600 */
            margin-top: 0.5rem;
            text-align: right;
        }
        
        /* RPMトグルボタンスタイル */
        .rpm-toggle-button {
             font-size: 0.875rem;
             padding: 0.5rem 1rem;
             border: 1px solid #cbd5e1;
             background-color: #ffffff;
             cursor: pointer;
             transition: all 0.2s;
        }
        .rpm-toggle-button:first-of-type {
            border-top-left-radius: 0.375rem;
            border-bottom-left-radius: 0.375rem;
        }
        .rpm-toggle-button:last-of-type {
            border-top-right-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            border-left-width: 0;
        }
        .rpm-toggle-button.active {
            background-color: #3b82f6; /* bg-blue-500 */
            color: #ffffff;
            border-color: #3b82f6;
            font-weight: 600;
        }

        /* フッター（型式表示）のスタイル */
        .model-footer {
            position: sticky;
            bottom: 0;
            background-color: #0f172a; /* bg-slate-900 */
            color: #f9fafb; /* bg-gray-50 */
            padding: 1.5rem 1.5rem; /* py-6 px-6 */
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .model-footer-title {
            font-size: 1rem; /* text-base */
            font-weight: 600; /* font-semibold */
            color: #cbd5e1; /* text-slate-300 */
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.025em; /* tracking-wide */
            margin-bottom: 0.75rem; /* mb-3 */
            display: block;
            text-align: center;
        }
        /* クリック領域のラッパー */
        .model-display-clickable-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .model-display-clickable-wrapper:hover {
            background-color: #1e293b; /* bg-slate-800 */
        }
        .model-display-wrapper {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.875rem; /* text-3xl */
            letter-spacing: 0.05em; /* tracking-wider */
            line-height: 1; /* leading-none */
            white-space: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            display: flex; 
            align-items: center; 
        }
        /* フッターのChevronアイコン */
        .footer-chevron-icon {
            width: 1.5rem; /* w-6 */
            height: 1.5rem; /* h-6 */
            stroke: #94a3b8; /* text-slate-400 */
            stroke-width: 2;
            fill: none;
            margin-left: 0.75rem; /* ml-3 */
            flex-shrink: 0;
        }
        
        .model-placeholder {
            display: inline-block;
            width: 1.1em;
            height: 1.1em;
            line-height: 1.1em;
            text-align: center;
            background-color: #334155; /* bg-slate-700 */
            color: #94a3b8; /* text-slate-400 */
            border-radius: 0.25rem;
            font-weight: bold;
            vertical-align: middle;
            margin: 0 0.2em;
            font-family: 'Inter', sans-serif;
            font-size: 0.8em;
        }
        .model-value {
            display: inline-block;
            min-width: 1.1em;
            height: 1.1em;
            line-height: 1.1em;
            text-align: center;
            background-color: #fcd34d; /* bg-amber-300 */
            color: #0f172a; /* text-slate-900 */
            border-radius: 0.25rem;
            font-weight: bold;
            vertical-align: middle;
            margin: 0 0.2em;
            padding: 0 0.25em;
            font-family: 'Inter', sans-serif;
            font-size: 0.8em;
            width: auto;
        }
        .model-static {
            margin: 0 0.1em;
            vertical-align: middle;
        }

        /* 型式選択モーダル */
        .model-dropdown-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            animation: fadeIn 0.2s ease;
        }
        .model-dropdown-content {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem;
            width: 90%;
            max-width: 24rem; /* max-w-md */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        #model-dropdown-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
        }
        #model-dropdown-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }
        .model-dropdown-item {
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .model-dropdown-item:hover {
            background-color: #f1f5f9; /* bg-slate-100 */
        }
        .model-dropdown-item.active {
            background-color: #dbeafe; /* bg-blue-100 */
            color: #1e40af;
            font-weight: 600;
        }
        .model-dropdown-close-btn {
            width: 100%;
            margin-top: 1.5rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background-color: #e2e8f0; /* bg-slate-200 */
            color: #334155;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .model-dropdown-close-btn:hover {
            background-color: #cbd5e1; /* bg-slate-300 */
        }

    </style>
</head>
<body class="bg-slate-100 min-h-screen md:p-8">

    <div class="max-w-7xl mx-auto bg-white shadow-xl overflow-hidden rounded-2xl">
        
        <!-- 上部テキスト --><div id="header-title" class="text-lg p-4 bg-slate-50 text-gray-700 font-semibold text-center rounded-t-2xl md:text-xl transition-colors duration-300">
            ご希望の最大吐出量に適したシリーズを選択してください。
        </div>

        <!-- 1. 製品カテゴリ コンテナ --><div id="product-container" class="w-full">
            <!-- 製品はJSによってここに動的に生成されます --></div> <!-- /product-container --></div>

    <!-- フッター --><div id="model-footer-container" class="model-footer" style="display: none;">
        <span class="model-footer-title">選択中の型式</span>
        <!-- ★ 新規: クリック領域 -->
        <div id="model-display-clickable" class="model-display-clickable-wrapper">
            <div class="model-display-wrapper">
                <span class="model-static">FTP-</span>
                <span id="model-part-1"></span>
                <span id="model-part-2"></span>
                <span id="model-part-3"></span>
                <span id="model-part-4"></span>
                <span id="model-part-5"></span>
                <span id="model-part-6"></span>
                <span id="model-part-7"></span>
                <span id="model-part-8"></span>
                <span id="model-part-9"></span>
                <span id="model-part-10"></span>
                <span id="model-part-11"></span> 
            </div>
            <!-- ★ 新規: Chevron Icon -->
            <svg class="footer-chevron-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
        </div>
    </div>
    
    <!-- ★ 新規: 型式選択モーダル -->
    <div id="model-dropdown-modal" class="model-dropdown-overlay" style="display: none;">
        <div class="model-dropdown-content">
            <h3 id="model-dropdown-title">型式を選択</h3>
            <div id="model-dropdown-list">
                <!-- JSで挿入 -->
            </div>
            <button id="model-dropdown-close" class="model-dropdown-close-btn">閉じる</button>
        </div>
    </div>


    <script>
        // --- 製品データ ---
        const productData = [
            {
                id: "1RA",
                name: "1RA",
                imageSrc: "https://lh3.googleusercontent.com/d/1_7E2FnO12mlbeT3WG9U8zDKjI4vLFn3U",
                colorClass: "text-pump-lighterBlue",
                ringColor: "#cce7ff",
                capacitySpec: "約5Lまで",
                capacityPercent: "20%",
                charts: {
                    chart1: {
                        label: "ご希望の性能に適した型式を選択してください", 
                        xAxisLabel: "最大吐出量(L/min)", 
                        yAxisLabel: "最大吐出圧力(MPa)", 
                        datasets: [
                            {
                                label: "100",
                                data: [{x: 0, y: 0.5}, {x: 2.0, y: 0.5}], 
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                fill: true,
                                tension: 0.1
                            },
                            {
                                label: "200",
                                data: [{x: 2.0, y: 0.5}, {x: 3.2, y: 0.5}], 
                                borderColor: 'rgb(234, 179, 8)',
                                backgroundColor: 'rgba(234, 179, 8, 0.2)',
                                fill: true,
                                tension: 0.1
                            },
                            {
                                label: "300",
                                data: [{x: 3.2, y: 0.5}, {x: 4.5, y: 0.5}], 
                                borderColor: 'rgb(34, 197, 94)',
                                backgroundColor: 'rgba(34, 197, 94, 0.2)',
                                fill: true,
                                tension: 0.1
                            }
                        ]
                    }
                },
                options: [],
                // 1RAの詳細データ
                details: {
                    specTable: [
                        { model: "100", volume: 1.16, flow1500: 1.74, flow1800: 2.08, pressure: 0.5, speed: 2000, weight: 1.1 },
                        { model: "200", volume: 1.80, flow1500: 2.70, flow1800: 3.24, pressure: 0.5, speed: 2000, weight: 1.2 },
                        { model: "300", volume: 2.50, flow1500: 3.75, flow1800: 4.50, pressure: 0.5, speed: 2000, weight: 1.3 }
                    ],
                    flowChart: { 
                        label: "流量特性 (1500min-1)",
                        xAxisLabel: "圧力(MPa)",
                        yAxisLabel: "吐出量(L/min)",
                        datasets: [
                            { label: "100", data: [{x: 0.1, y: 1.69}, {x: 0.2, y: 1.67}, {x: 0.3, y: 1.64}, {x: 0.4, y: 1.62}, {x: 0.5, y: 1.59}], borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.2)', fill: false }, 
                            { label: "200", data: [{x: 0.1, y: 2.72}, {x: 0.2, y: 2.70}, {x: 0.3, y: 2.67}, {x: 0.4, y: 2.65}, {x: 0.5, y: 2.62}], borderColor: 'rgb(234, 179, 8)', backgroundColor: 'rgba(234, 179, 8, 0.2)', fill: false }, 
                            { label: "300", data: [{x: 0.1, y: 3.71}, {x: 0.2, y: 3.69}, {x: 0.3, y: 3.68}, {x: 0.4, y: 3.66}, {x: 0.5, y: 3.64}], borderColor: 'rgb(34, 197, 94)', backgroundColor: 'rgba(34, 197, 94, 0.2)', fill: false } 
                        ]
                    },
                    powerChart: { 
                        label: "所要電力 (1500min-1)",
                        xAxisLabel: "圧力(MPa)",
                        yAxisLabel: "軸電力(W)",
                        datasets: [
                            { label: "100", data: [{x: 0.1, y: 25}, {x: 0.2, y: 34}, {x: 0.3, y: 44}, {x: 0.4, y: 54}, {x: 0.5, y: 63}], borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.2)', fill: false }, 
                            { label: "200", data: [{x: 0.1, y: 29}, {x: 0.2, y: 40}, {x: 0.3, y: 51}, {x: 0.4, y: 63}, {x: 0.5, y: 75}], borderColor: 'rgb(234, 179, 8)', backgroundColor: 'rgba(234, 179, 8, 0.2)', fill: false }, 
                            { label: "300", data: [{x: 0.1, y: 36}, {x: 0.2, y: 49}, {x: 0.3, y: 63}, {x: 0.4, y: 77}, {x: 0.5, y: 91}], borderColor: 'rgb(34, 197, 94)', backgroundColor: 'rgba(34, 197, 94, 0.2)', fill: false } 
                        ]
                    }
                }
            },
            { 
                id: "1A",
                name: "1A",
                imageSrc: "https://lh3.googleusercontent.com/d/1AyvbUYDkMSd0yGd5_lhlQpX2a7Zo-S2C",
                colorClass: "text-pump-lightBlue",
                ringColor: "#add8e6",
                capacitySpec: "約10Lまで",
                capacityPercent: "35%",
                charts: { 
                    chart1: {
                        label: "ご希望の性能に適した型式を選択してください",
                        xAxisLabel: "最大吐出量(L/min)", 
                        yAxisLabel: "最大吐出圧力(MPa)", 
                        datasets: [
                            {
                                label: "10",
                                data: [{x: 0, y: 0.5}, {x: 1.4, y: 0.5}], 
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                fill: true
                            },
                            {
                                label: "11",
                                data: [{x: 1.4, y: 0.5}, {x: 2.7, y: 0.5}], 
                                borderColor: 'rgb(234, 179, 8)',
                                backgroundColor: 'rgba(234, 179, 8, 0.2)',
                                fill: true
                            },
                            {
                                label: "12",
                                data: [{x: 2.7, y: 0.5}, {x: 4.5, y: 0.5}], 
                                borderColor: 'rgb(34, 197, 94)',
                                backgroundColor: 'rgba(34, 197, 94, 0.2)',
                                fill: true
                            },
                            {
                                label: "13",
                                data: [{x: 4.5, y: 0.5}, {x: 8.1, y: 0.5}], 
                                borderColor: 'rgb(239, 68, 68)',
                                backgroundColor: 'rgba(239, 68, 68, 0.2)',
                                fill: true
                            }
                        ]
                    }
                },
                options: [ 
                    { 
                        name: "ポンプ単体", 
                        enabled: true, 
                        modelConfig: { part3: null, part4: "A", part5: null, part6: null, part7: null, part11: null },
                        subOptions: [],
                        additionalSubOptions: [ 
                            { name: "標準", modelPart: "S" },
                            { name: "燃料油・クーラント用", modelPart: "WO" } 
                        ],
                        notes: "単体"
                    },
                    { 
                        name: "ポンプ・モータ 一体型", 
                        enabled: true,
                        modelConfig: { part3: null, part4: "S", part5: null, part6: "A", part7: "M", part8: null, part9: null, part11: null },
                        subOptions: [
                            { 
                                name: "単相モータ", 
                                type: "motor",
                                modelConfig: { part3: "1ME", part4: null }, 
                                additionalSubOptions: [ 
                                    { name: "標準", modelPart: "S" },
                                    { name: "燃料油・クーラント用", modelPart: "WO" } 
                                ]
                            },
                            { 
                                name: "三相モータ", 
                                type: "motor",
                                modelConfig: { part3: "1E", part4: null }, 
                                additionalSubOptions: [ 
                                    { name: "標準", modelPart: "S" },
                                    { name: "燃料油・クーラント用", modelPart: "WO" } 
                                ]
                            },
                            { 
                                name: "各国規制対応", 
                                type: "motor",
                                modelConfig: { part3: "1E", part4: null }, 
                                additionalSubOptions: [ 
                                    { name: "標準", modelPart: "S" },
                                    { name: "燃料油・クーラント用", modelPart: "WO" } 
                                ]
                            }
                        ],
                        notes: "一体型"
                    },
                    { 
                        name: "ベースカップリング取付型", 
                        enabled: true,
                        modelConfig: { part3: null, part4: "A", part5: null, part6: null, part7: null, part11: null },
                        subOptions: [], 
                        additionalSubOptions: [],
                        notes: "ベースカップリング取付型"
                    }
                ],
                details: null 
            },
            {
                id: "2A",
                name: "2A",
                imageSrc: "https://lh3.googleusercontent.com/d/1bb1Ne5IkZxEliA29xWxNoJE3BeMCfg-d",
                colorClass: "text-pump-lightGreen",
                ringColor: "#90ee90",
                capacitySpec: "約40Lまで",
                capacityPercent: "50%",
                charts: {
                    chart1: {
                        label: "ご希望の性能に適した型式を選択してください", 
                        xAxisLabel: "最大吐出量(L/min)", 
                        yAxisLabel: "最大吐出圧力(MPa)", 
                        datasets: [{ 
                            label: "2A",
                            data: [{x: 0, y: 1.2}, {x: 20, y: 1.0}, {x: 30, y: 0.8}, {x: 40, y: 0.5}],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: true,
                            tension: 0.1
                        }]
                    }
                },
                options: [ 
                    { 
                        name: "ポンプ単体", 
                        enabled: true, 
                        modelConfig: { part3: null, part4: "A", part5: null, part6: null, part7: null, part11: null },
                        subOptions: [],
                        additionalSubOptions: [ 
                            { name: "標準", modelPart: "S" },
                            { name: "燃料油・クーラント用", modelPart: "WO" } 
                        ],
                        notes: "単体"
                    },
                    { 
                        name: "ポンプ・モータ 一体型", 
                        enabled: true,
                        modelConfig: { part3: null, part4: "S", part5: null, part6: "A", part7: "M", part8: null, part9: null, part11: null },
                        subOptions: [
                            { 
                                name: "単相モータ", 
                                type: "motor",
                                modelConfig: { part3: "2ME", part4: null }, 
                                additionalSubOptions: [ 
                                    { name: "標準", modelPart: "S" },
                                    { name: "燃料油・クーラント用", modelPart: "WO" } 
                                ]
                            },
                            { 
                                name: "三相モータ", 
                                type: "motor",
                                modelConfig: { part3: "2E", part4: null }, 
                                additionalSubOptions: [ 
                                    { name: "標準", modelPart: "S" },
                                    { name: "燃料油・クーラント用", modelPart: "WO" } 
                                ]
                            },
                            { 
                                name: "各国規制対応", 
                                type: "motor",
                                modelConfig: { part3: "2E", part4: null }, 
                                additionalSubOptions: [ 
                                    { name: "標準", modelPart: "S" },
                                    { name: "燃料油・クーラント用", modelPart: "WO" } 
                                ]
                            }
                        ],
                        notes: "一体型"
                    },
                    { 
                        name: "ベースカップリング取付型", 
                        enabled: true,
                        modelConfig: { part3: null, part4: "A", part5: null, part6: null, part7: null, part11: null },
                        subOptions: [], 
                        additionalSubOptions: [],
                        notes: "ベースカップリング取付型"
                    }
                ],
                details: null 
            },
            {
                id: "3F",
                name: "3F (A/B)",
                imageSrc: "https://lh3.googleusercontent.com/d/135LDHJhsQNJykVvSF5jtF_XccXSfMz0z",
                colorClass: "text-pump-purple",
                ringColor: "#d8b4fe",
                capacitySpec: "約95Lまで",
                capacityPercent: "75%",
                charts: {
                    chart1: {
                        label: "ご希望の性能に適した型式を選択してください", 
                        xAxisLabel: "最大吐出量(L/min)", 
                        yAxisLabel: "最大吐出圧力(MPa)", 
                        datasets: [{ 
                            label: "3F",
                            data: [{x: 0, y: 1.5}, {x: 40, y: 1.2}, {x: 70, y: 1.0}, {x: 95, y: 0.7}],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: true,
                            tension: 0.1
                        }]
                    }
                },
                options: [ 
                    { 
                        name: "ポンプ単体", 
                        enabled: true, 
                        modelConfig: { part3: null, part4: "A", part5: null, part6: null, part7: null, part11: null },
                        subOptions: [],
                        additionalSubOptions: [ 
                            { name: "標準", modelPart: "S" },
                            { name: "燃料油・クーラント用", modelPart: "WO" } 
                        ],
                        notes: "単体"
                    },
                    { 
                        name: "ポンプ・モータ 一体型", 
                        enabled: true,
                        modelConfig: { part3: null, part4: "S", part5: null, part6: "A", part7: "M", part8: null, part9: null, part11: null },
                        subOptions: [
                            { 
                                name: "単相モータ", 
                                type: "motor",
                                modelConfig: { part3: "3ME", part4: null }, 
                                additionalSubOptions: [ 
                                    { name: "標準", modelPart: "S" },
                                    { name: "燃料油・クーラント用", modelPart: "WO" } 
                                ]
                            },
                            { 
                                name: "三相モータ", 
                                type: "motor",
                                modelConfig: { part3: "3E", part4: null }, 
                                additionalSubOptions: [ 
                                    { name: "標準", modelPart: "S" },
                                    { name: "燃料油・クーラント用", modelPart: "WO" } 
                                ]
                            },
                            { 
                                name: "各国規制対応", 
                                type: "motor",
                                modelConfig: { part3: "3E", part4: null }, 
                                additionalSubOptions: [ 
                                    { name: "標準", modelPart: "S" },
                                    { name: "燃料油・クーラント用", modelPart: "WO" } 
                                ]
                            }
                        ],
                        notes: "一体型"
                    },
                    { 
                        name: "ベースカップリング取付型", 
                        enabled: true,
                        modelConfig: { part3: null, part4: "A", part5: null, part6: null, part7: null, part11: null },
                        subOptions: [], 
                        additionalSubOptions: [],
                        notes: "ベースカップリング取付型"
                    }
                ],
                details: null 
            },
            {
                id: "3H",
                name: "3H",
                imageSrc: "https://lh3.googleusercontent.com/d/1hwGdOkkK47VOcf9sGw4Gm14P_Y2j8OXh",
                colorClass: "text-pump-blue",
                ringColor: "#2563eb",
                capacitySpec: "100L以上",
                capacityPercent: "100%",
                charts: {
                    chart1: {
                        label: "ご希望の性能に適した型式を選択してください", 
                        xAxisLabel: "最大吐出量(L/min)", 
                        yAxisLabel: "最大吐出圧力(MPa)", 
                        datasets: [{ 
                            label: "3H",
                            data: [{x: 0, y: 2.0}, {x: 50, y: 1.8}, {x: 80, y: 1.5}, {x: 110, y: 1.0}],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: true,
                            tension: 0.1
                        }]
                    }
                },
                options: [ 
                    { 
                        name: "ポンプ単体", 
                        enabled: true, 
                        modelConfig: { part3: null, part4: "A", part5: null, part6: null, part7: null, part11: null },
                        subOptions: [],
                        additionalSubOptions: [ 
                            { name: "標準", modelPart: "S" },
                            { name: "燃料油・クーラント用", modelPart: "WO" } 
                        ],
                        notes: "単体"
                    },
                    { 
                        name: "ポンプ・モータ 一体型", 
                        enabled: true,
                        modelConfig: { part3: null, part4: "S", part5: null, part6: "A", part7: "M", part8: null, part9: null, part11: null },
                        subOptions: [
                            { 
                                name: "単相モータ", 
                                type: "motor",
                                modelConfig: { part3: "3HME", part4: null }, 
                                additionalSubOptions: [ 
                                    { name: "標準", modelPart: "S" },
                                    { name: "燃料油・クーラント用", modelPart: "WO" } 
                                ]
                            },
                            { 
                                name: "三相モータ", 
                                type: "motor",
                                modelConfig: { part3: "3HE", part4: null }, 
                                additionalSubOptions: [ 
                                    { name: "標準", modelPart: "S" },
                                    { name: "燃料油・クーラント用", modelPart: "WO" } 
                                ]
                            },
                            { 
                                name: "各国規制対応", 
                                type: "motor",
                                modelConfig: { part3: "3HE", part4: null }, 
                                additionalSubOptions: [ 
                                    { name: "標準", modelPart: "S" },
                                    { name: "燃料油・クーラント用", modelPart: "WO" } 
                                ]
                            }
                        ],
                        notes: "一体型"
                    }
                ],
                details: null 
            }
        ];

        // --- DOM読み込み後の処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- グローバル変数・要素取得 ---
            const productContainer = document.getElementById('product-container');
            const headerTitle = document.getElementById('header-title');
            const originalTitleText = headerTitle.textContent.trim();
            
            // フッター関連 (model-part-1 から model-part-11 まで拡張)
            const modelFooterContainer = document.getElementById('model-footer-container');
            const modelParts = Array.from({length: 11}, (_, i) => document.getElementById(`model-part-${i + 1}`));

            // 状態 (currentModel オブジェクトを拡張)
            let currentModel = { 
                base: null,        // 例: 1A
                id: null,          // 例: 1A
                chartSelection: null, // 例: 100 (グラフで選択された型式)
                optionL1: null,    // 例: ポンプ単体 / ポンプ・モータ 一体型 (選択されたL1オプションオブジェクト全体)
                optionL2: null,    // 例: 単相モータ (選択されたL2オプションオブジェクト全体)
                optionL3: null     // 例: 標準 (選択されたL3オプションオブジェクト全体)
            };
            let activeDetailCharts = []; // ★ 追加: 詳細グラフインスタンスを保持

            // --- 関数定義 ---

            /**
             * 1つの製品カラムのHTMLを生成
             */
            function createProductColumnHTML(product) {
                const showOptions = product.options.length > 0;
                const optionsClass = showOptions ? 'has-options-true' : 'has-options-false';
                const chartContainerId = `chart-container-${product.id}`;
                const chartTitle = product.charts.chart1.label;

                const optionsL1HTML = product.options.map((opt, index) => {
                    const disabledAttr = opt.enabled ? '' : 'disabled';
                    return `<button 
                                class="option-button option-level-1-button flex-1" 
                                data-product-id="${product.id}" 
                                data-option-index="${index}"
                                ${disabledAttr}>
                                ${opt.name}
                            </button>`;
                }).join('');

                // ★ 修正: レイアウト反転 + 詳細コンテナのプレースホルダー追加
                return `
                <div class="capacity-column col-${product.id} border-b border-gray-200 ${optionsClass}">
                    
                    <div class="product-button-wrapper">
                        <button class="product-button group" style="--tw-ring-color: ${product.ringColor};"
                                data-model-base="${product.id}" data-model-id="${product.id}">
                            <img src="${product.imageSrc}"
                                 alt="${product.name} 製品写真" 
                                 class="absolute inset-0 w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black bg-opacity-30 group-hover:bg-opacity-20 transition-all"></div>
                            <span class="absolute bottom-4 left-4 text-2xl font-bold text-white ${product.colorClass}">${product.name}</span>
                        </button>
                    </div>
                    
                    <div class="capacity-bar-container">
                        <div class="capacity-bar-fill" style="width: ${product.capacityPercent};"></div>
                        <span class="capacity-spec-text">${product.capacitySpec}</span>
                    </div>

                    <div class="new-menu-item new-menu-column-wrapper"> 
                        
                        ${showOptions ? `
                        <div class="options-area-wrapper p-4 border-b border-gray-200"> 
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">製品構成を選択</h3>
                            <div class="flex flex-col gap-4">
                                <div class="options-level-1 flex flex-row gap-2">
                                    ${optionsL1HTML}
                                </div>
                                <!-- サブオプションコンテナ (JSで中身を描画) --><div class="sub-options-container flex-col" style="display: none;">
                                    <!-- レベル2のオプションがここに入る --><div class="options-level-2 flex flex-row flex-wrap gap-2 mb-2"></div>
                                    <!-- レベル3のオプションがここに入る --><div class="options-level-3 flex flex-row flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <div class="graphs-area-wrapper p-4"> 
                            <div id="${chartContainerId}" class="chart-wrapper bg-white rounded-lg shadow-lg">
                                 <h4 class="chart-title">${chartTitle}</h4>
                            </div>
                        </div>

                    </div>
                    
                    <!-- ★ 新規: 製品詳細コンテナ -->
                    <div id="product-details-${product.id}" class="product-details-container" style="display: none;">
                        <!-- JSで中身が描画されます -->
                    </div>
                </div>
                `;
            }


            /**
             * 製品データを基にHTMLをコンテナに描画
             */
            function generateProductColumns() {
                const allProductsHTML = productData.map(createProductColumnHTML).join('');
                productContainer.innerHTML = allProductsHTML;
            }
            
            /**
             * プレースホルダーSPANを生成
             * @param {string} content - プレースホルダーに表示する文字
             * @param {string} className - 追加するクラス名
             */
            function createPlaceholder(content = '□', className = '') {
                const span = document.createElement('span');
                span.className = `model-placeholder ${className}`.trim();
                span.textContent = content;
                return span;
            }

            /**
             * 値SPANを生成
             * @param {string} content - 表示する値
             */
            function createValue(content) {
                const span = document.createElement('span');
                span.className = 'model-value';
                span.textContent = content;
                return span;
            }

            /**
             * 型式フッターの表示を更新
             */
            function updateModelDisplay(scrollToFooter = false) {
                
                // ★ 修正: フッター表示判定
                if (!currentModel.base) {
                    modelFooterContainer.style.display = 'none';
                    return;
                }

                let shouldShowFooter = false;
                if (currentModel.id === "1RA") {
                    if (currentModel.chartSelection) { // 1RAはグラフ選択時に表示
                        shouldShowFooter = true;
                    }
                } else if (currentModel.optionL1) {
                    if (currentModel.optionL1.name === "ポンプ・モータ 一体型") {
                        if (currentModel.optionL2) { // 一体型はL2選択時に表示
                            shouldShowFooter = true;
                        }
                    } else { // ポンプ単体、ベースカップリングはL1選択時に表示
                        shouldShowFooter = true;
                    }
                }
                
                if (!shouldShowFooter) {
                    modelFooterContainer.style.display = 'none';
                    return; // 表示条件を満たさなければここで終了
                }

                // 毎回全クリア
                modelParts.forEach(part => { 
                    if (part) part.innerHTML = ''; 
                });
                
                if (modelFooterContainer.style.display === 'none') {
                    modelFooterContainer.style.display = 'flex'; 
                    scrollToFooter = true; 
                }

                // 型式表示ロジック
                if (currentModel.id === "1RA") {
                    modelParts[0].appendChild(createValue(currentModel.id)); // 1RA
                    modelParts[1].appendChild(createStaticText("-"));
                    modelParts[2].appendChild(currentModel.chartSelection ? createValue(currentModel.chartSelection) : createPlaceholder("□")); // ポンプ型式
                } else if (["1A", "2A", "3F", "3H"].includes(currentModel.id)) { 
                    const baseId = currentModel.id; 
                    
                    if (currentModel.optionL1 && currentModel.optionL1.name === "ポンプ単体") {
                        modelParts[0].appendChild(currentModel.chartSelection ? createValue(currentModel.chartSelection) : createPlaceholder("□")); // ポンプ型式
                        modelParts[1].appendChild(createValue(currentModel.optionL1.modelConfig.part4)); // A
                        
                        // ★ 修正: S/K/WO ロジック
                        if (currentModel.optionL3) {
                            if (currentModel.optionL3.modelPart === "S") {
                                // 「標準」の場合は何も表示しない
                            } else {
                                modelParts[2].appendChild(createValue(currentModel.optionL3.modelPart)); // WO
                            }
                        } else {
                            modelParts[2].appendChild(createPlaceholder("□")); // S/K
                        }

                        modelParts[3].appendChild(createPlaceholder("□")); 
                        modelParts[4].appendChild(createPlaceholder("□")); 
                        modelParts[5].appendChild(createPlaceholder("□")); 
                        modelParts[6].appendChild(createStaticText("-"));
                        modelParts[7].appendChild(createPlaceholder("□")); 
                    } 
                    else if (currentModel.optionL1 && currentModel.optionL1.name === "ポンプ・モータ 一体型") {
                        const l2Selected = currentModel.optionL2;
                        const l3Selected = currentModel.optionL3;
                        if (l2Selected) {
                            modelParts[0].appendChild(createValue(l2Selected.modelConfig.part3)); // 例: 1ME, 2E
                            modelParts[1].appendChild(createPlaceholder("□")); 
                            modelParts[2].appendChild(createValue(currentModel.chartSelection ? currentModel.chartSelection : "□")); // ポンプ型式
                            modelParts[3].appendChild(createValue(currentModel.optionL1.modelConfig.part6)); // A
                            
                            if (l3Selected) {
                                if (l3Selected.modelPart === "S") {
                                    // 「標準」の場合は何も表示しない
                                } else {
                                    modelParts[4].appendChild(createValue(l3Selected.modelPart)); // WO
                                }
                            } else {
                                modelParts[4].appendChild(createPlaceholder("□")); // S/K
                            }

                        } else {
                            // ★ 修正: L2が選択されていない場合 (L1のみ選択)
                            modelParts[0].appendChild(createPlaceholder(baseId[0] + "M")); // ヒント
                            modelParts[1].appendChild(createPlaceholder("□")); 
                            modelParts[2].appendChild(createPlaceholder("□")); 
                            modelParts[3].appendChild(createPlaceholder("A")); 
                            modelParts[4].appendChild(createPlaceholder("□"));
                        }
                        
                        modelParts[5].appendChild(createValue(currentModel.optionL1.modelConfig.part7)); // M
                        modelParts[6].appendChild(createPlaceholder("□")); 
                        modelParts[7].appendChild(createPlaceholder("□")); 
                        
                        modelParts[8].appendChild(createStaticText(`-`));
                        modelParts[9].appendChild(createPlaceholder("□"));
                    }
                    else if (currentModel.optionL1 && currentModel.optionL1.name === "ベースカップリング取付型") {
                        modelParts[0].appendChild(currentModel.chartSelection ? createValue(currentModel.chartSelection) : createPlaceholder("□")); 
                        modelParts[1].appendChild(createValue(currentModel.optionL1.modelConfig.part4)); // A
                        modelParts[2].appendChild(createPlaceholder("S")); // 仮
                        modelParts[3].appendChild(createPlaceholder("□")); 
                        modelParts[4].appendChild(createPlaceholder("□")); 
                        modelParts[5].appendChild(createPlaceholder("□")); 
                        modelParts[6].appendChild(createStaticText("-"));
                        modelParts[7].appendChild(createPlaceholder("□")); 
                    } else {
                        // L1未選択 (フッターは表示されている状態)
                        modelParts[0].appendChild(currentModel.chartSelection ? createValue(currentModel.chartSelection) : createPlaceholder("□")); 
                        modelParts[1].appendChild(createPlaceholder("A")); 
                        modelParts[2].appendChild(createPlaceholder("□")); 
                        modelParts[3].appendChild(createPlaceholder("□")); 
                        modelParts[4].appendChild(createPlaceholder("□")); 
                        modelParts[5].appendChild(createPlaceholder("□")); 
                        modelParts[6].appendChild(createStaticText("-"));
                        modelParts[7].appendChild(createPlaceholder("□")); 
                    }
                }
                
                if (scrollToFooter) {
                    setTimeout(() => {
                        modelFooterContainer.scrollIntoView({ behavior: 'smooth', 'block': 'end' });
                    }, 300);
                }
            }

            // 静的なテキストを表示するためのヘルパー関数
            function createStaticText(text) {
                const span = document.createElement('span');
                span.className = 'model-static';
                span.textContent = text;
                return span;
            }

            /**
             * ★ 修正: メインSVGグラフを破棄
             */
            function destroyMainSvgCharts() {
                productData.forEach(product => {
                    const container = document.getElementById(`chart-container-${product.id}`);
                    if (container) {
                        const title = container.querySelector('.chart-title');
                        container.innerHTML = '';
                        if (title) {
                            container.appendChild(title);
                        }
                    }
                });
            }
            
            /**
             * ★ 修正: 詳細Chart.jsグラフを破棄
             */
            function destroyDetailCharts() {
                activeDetailCharts.forEach(chart => chart.destroy());
                activeDetailCharts = [];
            }


            /**
             * グラフ描画のメイン関数
             */
            function renderProductCharts(column) {
                destroyMainSvgCharts(); 
                const button = column.querySelector('.product-button');
                if (!button) return;
                const productId = button.dataset.modelId;
                const product = productData.find(p => p.id === productId);
                if (!product || !product.charts) return;
                
                // ★ メイングラフはSVG、詳細はChart.js (renderMainSvgChart)
                renderMainSvgChart(product, `chart-container-${product.id}`, product.charts.chart1);
            }
            
            /**
             * ★ 修正: メインSVGグラフ描画 (旧 renderSvgChart)
             */
            function renderMainSvgChart(product, containerId, chartData) {
                const container = document.getElementById(containerId);
                if (!container) return;

                // グラフタイトルをコンテナから取得または設定
                let titleEl = container.querySelector('.chart-title');
                if (!titleEl) {
                     titleEl = document.createElement('h4');
                     titleEl.className = 'chart-title';
                     titleEl.textContent = chartData.label || 'グラフ';
                     container.appendChild(titleEl);
                }

                const datasets = chartData.datasets;
                if (!datasets || datasets.length === 0) return;

                const svgWidth = 500;
                const svgHeight = 250; 
                const padding = { top: 40, right: 40, bottom: 40, left: 60 };
                
                const chartWidth = svgWidth - padding.left - padding.right;
                const chartHeight = svgHeight - padding.top - padding.bottom;
                
                // 1. X/Y軸の最小/最大を動的に計算
                const allDataPoints = datasets.flatMap(ds => ds.data);
                const xValues = allDataPoints.map(d => d.x);
                const yValues = allDataPoints.map(d => d.y);
                
                let minX = 0; // Xは0固定
                let maxX = Math.max(...xValues);
                let minY = Math.min(...yValues);
                let maxY = Math.max(...yValues);

                // 2. スケール調整
                if (minY === maxY) {
                    minY = minY - 0.1;
                    maxY = maxY + 0.1;
                } else { 
                    minY = 0; 
                    maxY = maxY * 1.1; 
                }
                
                // X軸の最大値と刻み幅をキリの良い値に
                maxX = Math.ceil(maxX * 1.05); 
                if (maxX <= 1) {
                    maxX = 1; // 最小 1
                } else if (maxX <= 5) {
                    maxX = Math.ceil(maxX); // 4.5 -> 5
                } else if (maxX <= 10) {
                    maxX = Math.ceil(maxX / 2) * 2; // 8.1 -> 9 -> 10
                } else if (maxX <= 50) {
                    maxX = Math.ceil(maxX / 5) * 5; // 42 -> 45
                } else {
                    maxX = Math.ceil(maxX / 10) * 10; // 100 -> 100, 116 -> 120
                }

                const scaleX = (val) => padding.left + ((val - minX) / (maxX - minX)) * chartWidth;
                const scaleY = (val) => (val === 0 ? padding.top + chartHeight : padding.top + chartHeight - ((val - minY) / (maxY - minY)) * chartHeight);
                
                const yBottom = scaleY(minY); // Y軸の底 (グラフの底)
                
                let areasHTML = '';
                let textsHTML = '';
                
                // 3. グラフ本体 (Path) の描画
                datasets.forEach(ds => {
                    const label = ds.label;
                    const data = ds.data;
                    const color = ds.backgroundColor;
                    const borderColor = ds.borderColor;

                    const isHorizontalArea = data.every(d => d.y === data[0].y);
                    
                    let d;
                    let textX, textY;
                    let pathClass = "svg-chart-area"; // デフォルト (エリアグラフ)
                    let pathStyle = `fill="${color}"; stroke: ${borderColor};`;

                    if (isHorizontalArea) {
                        const x1 = scaleX(data[0].x);
                        const x2 = scaleX(data[data.length - 1].x); 
                        const yLine = scaleY(data[0].y); 
                        d = `M ${x1} ${yBottom} L ${x1} ${yLine} L ${x2} ${yLine} L ${x2} ${yBottom} Z`;
                        textX = (x1 + x2) / 2;
                        textY = yLine + (yBottom - yLine) / 2 + 6; 
                    } else {
                        // 線グラフ
                        const points = data.map(d => `${scaleX(d.x)} ${scaleY(d.y)}`).join(' L ');
                        const firstPoint = data[0];
                        const lastPoint = data[data.length - 1];
                        d = `M ${scaleX(firstPoint.x)} ${yBottom} L ${points} L ${scaleX(lastPoint.x)} ${yBottom} Z`;
                        textX = scaleX(lastPoint.x) - 15; 
                        textY = scaleY(lastPoint.y) - 15; 
                    }

                    areasHTML += `<path d="${d}" fill="${color}" class="svg-chart-area" data-submodel="${label}" style="${pathStyle}" />`;
                    textsHTML += `<text x="${textX}" y="${textY}" text-anchor="middle" class="svg-chart-text">${label}</text>`;
                });
                
                // 4. 軸 (Axis) の描画 (動的)
                let tickInterval = 1;
                if (maxX > 50) tickInterval = 10;
                else if (maxX > 10) tickInterval = 5;
                else if (maxX > 5) tickInterval = 2;
                else if (maxX <= 1) tickInterval = 0.2;
                
                const xAxisTicks = [];
                for (let i = 0; i <= maxX; i += tickInterval) {
                    xAxisTicks.push({ val: i, x: scaleX(i) });
                }
                
                const yAxisTicks = [];
                const yTickCount = (maxY < 1 ? 4 : 2); // Y軸が小さい場合は目盛りを増やす
                for (let i = 0; i <= yTickCount; i++) {
                    const val = minY + (maxY - minY) * (i / yTickCount);
                    yAxisTicks.push({ val: val.toFixed(1), y: scaleY(val) });
                }

                const axisHTML = `
                    <!-- X axis --><line x1="${padding.left}" y1="${yBottom}" x2="${scaleX(maxX)}" y2="${yBottom}" stroke="#9ca3af" />
                    <text x="${padding.left + chartWidth / 2}" y="${svgHeight - 5}" text-anchor="middle" fill="#4b5563" font-size="14">${chartData.xAxisLabel || 'X軸'}</text>
                    ${xAxisTicks.map(tick => `<text x="${tick.x}" y="${yBottom + 15}" text-anchor="middle" fill="#4b5563" font-size="12">${tick.val.toFixed(maxX <= 1 ? 1 : 0)}</text>`).join('')}
                    
                    <!-- Y axis --><line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${yBottom}" stroke="#9ca3af" />
                    <text x="${padding.left - 40}" y="${padding.top + chartHeight / 2}" text-anchor="middle" fill="#4b5563" font-size="14" transform="rotate(-90 ${padding.left - 40} ${padding.top + chartHeight / 2})">${chartData.yAxisLabel || 'Y軸'}</text>
                    ${yAxisTicks.map(tick => `<text x="${padding.left - 10}" y="${tick.y}" text-anchor="end" dominant-baseline="middle" fill="#4b5563" font-size="12">${tick.val}</text>`).join('')}
                `;

                // 5. SVG設定とイベントリスナー
                const svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svgElement.setAttribute("viewBox", `0 0 ${svgWidth} ${svgHeight}`);
                svgElement.setAttribute("class", "svg-chart");
                svgElement.setAttribute("preserveAspectRatio", "xMidYMid meet");
                svgElement.innerHTML = axisHTML + areasHTML + textsHTML;
                
                // 選択状態を復元
                const selectedChartValue = currentModel.chartSelection;
                if (selectedChartValue) {
                    const activeArea = svgElement.querySelector(`.svg-chart-area[data-submodel="${selectedChartValue}"]`);
                    if (activeArea) activeArea.classList.add('active');
                }
            
                // SVGクリック (グラフの型式: chartSelection)
                svgElement.querySelectorAll('.svg-chart-area').forEach(area => {
                    area.addEventListener('click', (event) => {
                        const subModelLabel = event.target.dataset.submodel;
                        const isActive = event.target.classList.contains('active');
                        
                        // 全エリアのアクティブ解除
                        svgElement.querySelectorAll('.svg-chart-area').forEach(a => a.classList.remove('active'));
                        
                        // ★ 修正: 詳細コンテナもクリア
                        clearProductDetails(product.id);

                        if (isActive) {
                            currentModel.chartSelection = null;
                        } else {
                            event.target.classList.add('active');
                            currentModel.chartSelection = subModelLabel;
                            // ★ 新規: 1RAの場合は詳細を描画
                            if (product.id === '1RA' && product.details) {
                                renderProductDetails(product, subModelLabel);
                            }
                        }
                        updateModelDisplay(true);
                    });
                });
                
                // 既存のSVGを削除してから追加
                const existingSvg = container.querySelector('.svg-chart');
                if (existingSvg) {
                    existingSvg.remove();
                }
                container.appendChild(svgElement);
            }
            
            /**
             * ★ 新規: 詳細グラフ (Chart.js) を描画
             */
            function renderDetailsChartJs(containerId, chartData, highlightLabel) {
                const container = document.getElementById(containerId);
                if (!container) return;

                // 既存のCanvasを削除して新しく作成
                const existingCanvas = container.querySelector('canvas');
                if(existingCanvas) existingCanvas.remove();
                
                const canvas = document.createElement('canvas');
                canvas.id = `${containerId}-canvas`;
                container.appendChild(canvas);
                const ctx = canvas.getContext('2d');

                // データセットをハイライト/非ハイライトに加工
                const processedDatasets = chartData.datasets.map(ds => {
                    const isHighlighted = ds.label === highlightLabel;
                    return {
                        ...ds,
                        borderWidth: isHighlighted ? 4 : 1.5, // ★ ハイライト
                        borderColor: isHighlighted ? ds.borderColor : 'rgba(180, 190, 200, 0.7)', // ★ 非ハイライト (濃いグレー)
                        backgroundColor: 'rgba(0,0,0,0)', // エリアフィルはなし
                        fill: false,
                        tension: 0.1
                    };
                });

                const chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: processedDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: chartData.xAxisLabel || 'X軸'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: chartData.yAxisLabel || 'Y軸'
                                },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // ★ 凡例を非表示
                            }
                        }
                    }
                });
                
                activeDetailCharts.push(chartInstance);
            }

            /**
             * ★ 新規: 製品詳細コンテナをクリア
             */
            function clearProductDetails(productId) {
                 const detailsContainer = document.getElementById(`product-details-${productId}`);
                 if (detailsContainer) {
                     detailsContainer.innerHTML = '';
                     detailsContainer.style.display = 'none';
                 }
                 // ★ Chart.js インスタンスも破棄
                 destroyDetailCharts();
            }

            /**
             * ★ 新規: 1RA 製品詳細を描画
             */
            function renderProductDetails(product, selectedModel) {
                const detailsContainer = document.getElementById(`product-details-${product.id}`);
                if (!detailsContainer || !product.details) return;

                const specData = product.details.specTable;
                const flowChartData = product.details.flowChart;
                const powerChartData = product.details.powerChart;
                
                let currentRpm = 1500; // デフォルト

                // 仕様表のHTMLを生成
                const tableHeader = `
                    <thead>
                        <tr>
                            <th>型式</th>
                            <th>一回転当たり<br>吐出量(ml/rev)</th>
                            <th id="flow-header-${product.id}">理論吐出量<br>(L/min)</th>
                            <th>最大吐出圧力<br>(Mpa)</th>
                            <th>最高回転数<br>(min-1)</th>
                            <th>概略質量<br>(kg)</th>
                        </tr>
                    </thead>
                `;
                const tableBody = specData.map(row => `
                    <tr class="${row.model === selectedModel ? 'highlight' : ''}">
                        <td>${row.model}</td>
                        <td>${row.volume.toFixed(2)}</td>
                        <td data-flow-1500="${row.flow1500.toFixed(2)}" data-flow-1800="${row.flow1800.toFixed(2)}">
                            ${currentRpm === 1500 ? row.flow1500.toFixed(2) : row.flow1800.toFixed(2)}
                        </td>
                        <td>${row.pressure.toFixed(1)}</td>
                        <td>${row.speed}</td>
                        <td>${row.weight.toFixed(1)}</td>
                    </tr>
                `).join('');

                // コンテナのHTMLを構築
                detailsContainer.innerHTML = `
                    <h2>${product.id} - ${selectedModel} 製品詳細</h2>
                    
                    <!-- 寸法図面 -->
                    <h3>寸法図面</h3>
                    <div class="p-4 border border-slate-300 rounded-lg bg-white">
                        <!-- ★ 修正: src を指定のURLに -->
                        <img src="https://lh3.googleusercontent.com/d/17sH1rf-gis2HNazVn-J9i2wSlGthrIvG" alt="寸法図面" class="w-full h-auto object-contain" onerror="this.src='https://placehold.co/800x400/e2e8f0/9ca3b8?text=IMAGE+NOT+FOUND'">
                    </div>

                    <!-- 仕様 -->
                    <div class="mt-6 relative">
                        <h3>仕様</h3>
                        <div class="absolute top-0 right-0">
                            <button class="rpm-toggle-button active" data-rpm="1500">1500min-1</button>
                            <button class="rpm-toggle-button" data-rpm="1800">1800min-1</button>
                        </div>
                        
                        <table class="spec-table mt-4">
                            ${tableHeader}
                            <tbody>${tableBody}</tbody>
                        </table>
                        <p class="spec-table-note">※最大吐出圧力は試供油をISO-VG46 油温40度とした値です(粘度・温度によりことなります)</p>

                        <!-- 流量特性グラフ -->
                        <h3 class="mt-6">流量特性</h3>
                        <div id="flow-chart-${product.id}" class="chart-wrapper bg-white rounded-lg shadow-lg" style="height: 300px;">
                             <h4 class="chart-title">${flowChartData.label}</h4>
                             <!-- ★ 修正: Canvas をJSで挿入 -->
                        </div>
                        
                        <!-- 所要電力グラフ -->
                        <h3 class="mt-6">所要電力</h3>
                        <div id="power-chart-${product.id}" class="chart-wrapper bg-white rounded-lg shadow-lg" style="height: 300px;">
                             <h4 class="chart-title">${powerChartData.label}</h4>
                             <!-- ★ 修正: Canvas をJSで挿入 -->
                        </div>
                    </div>
                `;

                // 詳細コンテナを表示
                detailsContainer.style.display = 'block';

                // ★ 修正: Chart.jsでグラフを描画
                renderDetailsChartJs(`flow-chart-${product.id}`, flowChartData, selectedModel);
                renderDetailsChartJs(`power-chart-${product.id}`, powerChartData, selectedModel);

                // RPMトグルボタンのイベントリスナー
                detailsContainer.querySelectorAll('.rpm-toggle-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const newRpm = e.target.dataset.rpm;
                        if (newRpm === currentRpm) return;
                        
                        currentRpm = newRpm;
                        
                        // ボタンのアクティブ状態を切り替え
                        detailsContainer.querySelectorAll('.rpm-toggle-button').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');

                        // 仕様表の理論吐出量を更新
                        detailsContainer.querySelector(`#flow-header-${product.id}`).innerHTML = `理論吐出量<br>(L/min)`;
                        detailsContainer.querySelectorAll('.spec-table tbody tr').forEach(tr => {
                            const cell = tr.cells[2];
                            cell.textContent = cell.dataset[`flow${newRpm}`];
                        });
                        
                        // TODO: 1800rpm時のグラフデータがあればグラフも更新
                        // (現在は1500min-1のデータしかないのでグラフはそのまま)
                    });
                });
            }
            
            /**
             * レベル2/3のオプションボタンを生成し、表示する
             */
            function renderSubOptions(column, parentOption, level) {
                const subOptionsContainer = column.querySelector('.sub-options-container');
                let targetDiv;
                let optionsToRender = [];

                if (level === 'L2') {
                    targetDiv = column.querySelector('.options-level-2');
                    optionsToRender = parentOption.subOptions;
                    // L3もクリア
                    column.querySelector('.options-level-3').innerHTML = '';
                    currentModel.optionL3 = null; 
                } else if (level === 'L3') {
                    targetDiv = column.querySelector('.options-level-3');
                    // L1/L2両方 L3 を additionalSubOptions から取得
                    optionsToRender = parentOption.additionalSubOptions;
                }
                
                targetDiv.innerHTML = ''; // 既存のサブオプションをクリア

                if (optionsToRender && optionsToRender.length > 0) {
                    const subOptionsHTML = optionsToRender.map((opt, index) => {
                        return `<button 
                                    class="option-button option-${level}-button" 
                                    data-option-index="${parentOption.optionIndex}" 
                                    data-sub-option-index="${index}"
                                    data-level="${level}">
                                    ${opt.name}
                                </button>`;
                    }).join('');
                    targetDiv.innerHTML = subOptionsHTML;
                    subOptionsContainer.style.display = 'flex'; // コンテナを表示
                } else {
                     // レベルのコンテナを空にする
                    targetDiv.innerHTML = '';
                }

                // L2とL3の両方が空の場合のみ、親コンテナを非表示
                const l2Content = column.querySelector('.options-level-2').innerHTML;
                const l3Content = column.querySelector('.options-level-3').innerHTML;
                if (!l2Content && !l3Content) {
                    subOptionsContainer.style.display = 'none';
                } else {
                    subOptionsContainer.style.display = 'flex';
                }
            }
            
            /**
             * ★ 新規: 型式選択モーダルを開く
             */
            function openModelDropdown() {
                const productId = currentModel.id;
                const product = productData.find(p => p.id === productId);
                if (!product) return;

                const datasets = product.charts.chart1.datasets;
                const modelList = datasets.map(ds => ds.label);
                
                const listContainer = document.getElementById('model-dropdown-list');
                listContainer.innerHTML = modelList.map(model => `
                    <button 
                        class="model-dropdown-item ${model === currentModel.chartSelection ? 'active' : ''}" 
                        data-model="${model}">
                        ${model}
                    </button>
                `).join('');
                
                document.getElementById('model-dropdown-title').textContent = `${productId} の型式を選択`;
                document.getElementById('model-dropdown-modal').style.display = 'flex';
            }
            
            /**
             * ★ 新規: 型式選択モーダルを閉じる
             */
            function closeModelDropdown() {
                document.getElementById('model-dropdown-modal').style.display = 'none';
            }


            /**
             * ★ 修正: イベントリスナーの集約
             */
            function setupEventListeners() {
                
                // --- (A) productContainer への集約リスナー ---
                productContainer.addEventListener('click', (e) => {
                    
                    // --- (A-1) 製品カラム (写真) のクリック ---
                    const clickableArea = e.target.closest('.product-button-wrapper');
                    if (clickableArea) {
                        const column = clickableArea.closest('.capacity-column');
                        if (!column) return;

                        const isAlreadyActive = column.classList.contains('column-active');
                        
                        // 詳細コンテナとSVGをクリア
                        clearProductDetails(column.querySelector('.product-button').dataset.modelId);
                        destroyMainSvgCharts(); 
                        
                        // 全ての状態をリセット
                        currentModel = { base: null, id: null, chartSelection: null, optionL1: null, optionL2: null, optionL3: null }; 
                        
                        // ★ 修正: productColumns を querySelectorAll で再取得
                        const productColumns = document.querySelectorAll('.capacity-column'); 
                        productColumns.forEach(col => {
                            col.classList.remove('column-active');
                            col.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('active'));
                            const subOptionsContainer = col.querySelector('.sub-options-container');
                            if (subOptionsContainer) subOptionsContainer.style.display = 'none';
                            clearProductDetails(col.querySelector('.product-button').dataset.modelId);
                        });
                        productContainer.classList.remove('has-active');

                        if (!isAlreadyActive) {
                            // カラムをアクティブ化
                            column.classList.add('column-active');
                            productContainer.classList.add('has-active');

                            const button = column.querySelector('.product-button');
                            if (button) {
                                currentModel.base = button.dataset.modelBase;
                                currentModel.id = button.dataset.modelId;
                            }

                            headerTitle.textContent = '＜　 シリーズ一覧に戻る';
                            headerTitle.classList.add('cursor-pointer', 'hover:text-blue-600');
                            renderProductCharts(column);

                            setTimeout(() => {
                                headerTitle.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }, 300); 
                        } else {
                            // カラムを非アクティブ化 (一覧に戻る)
                            headerTitle.textContent = originalTitleText;
                            headerTitle.classList.remove('cursor-pointer', 'hover:text-blue-600');
                        }
                        
                        updateModelDisplay(false);
                        return; // 他のクリックイベントと重複させない
                    }

                    // --- (A-2) オプションボタン (L1, L2, L3) のクリック ---
                    const currentActiveColumn = document.querySelector('.capacity-column.column-active');
                    if (!currentActiveColumn) return; 

                    const product = productData.find(p => p.id === currentModel.id);
                    if (!product) return;
                    
                    // --- レベル1 ボタン (ポンプ単体 など) ---
                    const l1Button = e.target.closest('.option-level-1-button');
                    if (l1Button) {
                        const optionIndex = parseInt(l1Button.dataset.optionIndex, 10);
                        const selectedOption = { ...product.options[optionIndex], optionIndex }; 
                        const isActive = l1Button.classList.contains('active');
                        
                        currentActiveColumn.querySelectorAll('.option-level-1-button').forEach(btn => btn.classList.remove('active'));
                        
                        const l2Div = currentActiveColumn.querySelector('.options-level-2');
                        const l3Div = currentActiveColumn.querySelector('.options-level-3');
                        const subOptionsContainer = currentActiveColumn.querySelector('.sub-options-container');
                        l2Div.innerHTML = '';
                        l3Div.innerHTML = '';
                        subOptionsContainer.style.display = 'none';
                        
                        currentModel.optionL1 = null;
                        currentModel.optionL2 = null;
                        currentModel.optionL3 = null;

                        if (!isActive) {
                            l1Button.classList.add('active');
                            currentModel.optionL1 = selectedOption;

                            if (selectedOption.subOptions && selectedOption.subOptions.length > 0) {
                                renderSubOptions(currentActiveColumn, selectedOption, 'L2');
                            }
                            if (selectedOption.additionalSubOptions && selectedOption.additionalSubOptions.length > 0) {
                                renderSubOptions(currentActiveColumn, selectedOption, 'L3');
                            }
                        }
                        
                        updateModelDisplay(true);
                        return; 
                    }

                    // --- レベル2 ボタン (単相モータ など) ---
                    const l2Button = e.target.closest('.option-L2-button[data-level="L2"]');
                    if (l2Button) {
                        const optionIndex = parseInt(l2Button.dataset.optionIndex, 10);
                        const subOptionIndex = parseInt(l2Button.dataset.subOptionIndex, 10);
                        
                        const selectedL1Option = currentModel.optionL1;
                        if (!selectedL1Option) return; 
                        
                        const selectedL2Option = { ...selectedL1Option.subOptions[subOptionIndex], optionIndex: subOptionIndex };
                        const isActive = l2Button.classList.contains('active');

                        const container = l2Button.closest('.options-level-2');
                        container.querySelectorAll('.option-L2-button').forEach(btn => btn.classList.remove('active'));
                        
                        const l3Div = currentActiveColumn.querySelector('.options-level-3');
                        l3Div.innerHTML = '';
                        
                        currentModel.optionL2 = null;
                        currentModel.optionL3 = null;
                        
                        if (!isActive) {
                            l2Button.classList.add('active');
                            currentModel.optionL2 = selectedL2Option;

                            if (selectedL2Option.additionalSubOptions && selectedL2Option.additionalSubOptions.length > 0) {
                                renderSubOptions(currentActiveColumn, selectedL2Option, 'L3');
                            }
                        }
                        
                        updateModelDisplay(true);
                        return; 
                    }

                    // --- レベル3 ボタン (標準、燃料油・クーラント用) ---
                    const l3Button = e.target.closest('.option-L3-button[data-level="L3"]');
                    if (l3Button) {
                        const subOptionIndex = parseInt(l3Button.dataset.subOptionIndex, 10);
                        const isActive = l3Button.classList.contains('active');

                        let parentOptionForL3 = null;
                        if (currentModel.optionL2 && currentModel.optionL2.additionalSubOptions) {
                            parentOptionForL3 = currentModel.optionL2;
                        } 
                        else if (currentModel.optionL1 && currentModel.optionL1.additionalSubOptions) {
                            parentOptionForL3 = currentModel.optionL1;
                        }
                        
                        if (parentOptionForL3) {
                            const selectedL3Option = parentOptionForL3.additionalSubOptions[subOptionIndex];
                            
                            const container = l3Button.closest('.options-level-3');
                            container.querySelectorAll('.option-L3-button').forEach(btn => btn.classList.remove('active'));
                            
                            currentModel.optionL3 = null;

                            if (!isActive) {
                                l3Button.classList.add('active');
                                currentModel.optionL3 = selectedL3Option;
                            }
                            
                            updateModelDisplay(false); 
                        }
                        return; 
                    }
                });


                // --- (B) ヘッダークリック (一覧に戻る) ---
                headerTitle.addEventListener('click', () => {
                    if (!productContainer.classList.contains('has-active')) return;
                    
                    productData.forEach(p => clearProductDetails(p.id));
                    destroyMainSvgCharts(); 
                    
                    currentModel = { base: null, id: null, chartSelection: null, optionL1: null, optionL2: null, optionL3: null }; 
                    
                    // ★ 修正: productColumns を querySelectorAll で再取得
                    const productColumns = document.querySelectorAll('.capacity-column');
                    productColumns.forEach(col => {
                        col.classList.remove('column-active');
                        col.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('active'));
                        const subOptionsContainer = col.querySelector('.sub-options-container');
                        if (subOptionsContainer) subOptionsContainer.style.display = 'none';
                    });
                    productContainer.classList.remove('has-active');
                    headerTitle.textContent = originalTitleText;
                    headerTitle.classList.remove('cursor-pointer', 'hover:text-blue-600');
                    updateModelDisplay(false);
                });
                
                // --- (C) フッタークリック (モーダル起動) ---
                document.getElementById('model-display-clickable').addEventListener('click', openModelDropdown);
                
                // --- (D) モーダル閉じるボタン ---
                document.getElementById('model-dropdown-close').addEventListener('click', closeModelDropdown);
                
                // --- (E) モーダル外側クリックで閉じる ---
                document.getElementById('model-dropdown-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'model-dropdown-modal') {
                        closeModelDropdown();
                    }
                });

                // --- (F) モーダル内リストアイテムクリック ---
                document.getElementById('model-dropdown-list').addEventListener('click', (e) => {
                    const button = e.target.closest('.model-dropdown-item');
                    if (!button) return;

                    const selectedModel = button.dataset.model;
                    currentModel.chartSelection = selectedModel;

                    closeModelDropdown();
                    updateModelDisplay(false); // フッター表示を更新

                    // メインSVGのハイライトを更新
                    const column = document.querySelector(`.col-${currentModel.id}`);
                    if(column) renderProductCharts(column);

                    // 1RAの場合は詳細も更新
                    if (currentModel.id === '1RA') {
                        clearProductDetails(currentModel.id);
                        renderProductDetails(productData.find(p => p.id === '1RA'), selectedModel);
                    }
                });
            }

            // --- 初期化処理 ---
            generateProductColumns();
            setupEventListeners();

        });
    </script>

</body>
</html>