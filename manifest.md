# プロジェクトマニフェスト: FTP選定ツール

## 1. プロジェクト概要

本プロジェクトは、ユーザーが要求仕様（吐出量、製品構成、オプション等）に基づいて最適なFTPポンプモデルを対話的に選定するための、モダンなWebアプリケーションです。直感的なUIとリアルタイムのフィードバックを通じて、複雑な製品選定プロセスを簡素化し、ユーザー体験を向上させることを目的としています。

## 2. 現状の仕様・機能一覧

現状のコードベースから実装されている機能は以下の通りです。

### 2.1. 基本的な製品選定フロー

-   **シリーズ選択**:
    -   製品シリーズ（1A, 1RA, 2A, 3F, 3H等）をモダンなカードデザインで一覧表示。
    -   各カードには最大吐出量を示すインジケーター（キャパシティバー）を表示。バーは液体が左から右へ満たされていくようなアニメーションを持ち、テキストの色も連動して変化します。
    -   カードをクリックすると、アコーディオン形式で詳細なオプション選択画面が展開されるSPA（シングルページアプリケーション）ライクなUI。
    -   **電光掲示板風の説明文**:
        -   製品カード展開時に、製品の特長を伝えるテキストが電光掲示板のように右から左へ流れるアニメーションで表示されます。
        -   **表示タイミングの制御**: `1RA`のようにトップレベルに説明文を持つ製品はカード展開時に即座に表示されますが、`1A`以降のようにオプション階層に説明文を持つ製品は、ユーザーがL1（製品構成）やL2（モータ種別）などのオプションを選択したタイミングで初めて表示されます。
        -   **内容の動的切り替え**: ユーザーが「用途」を切り替えると、その選択に応じて表示される説明文の内容も動的に更新されます。

-   **段階的なオプション選択**:
    -   **L1 (製品構成)**: 「ポンプ単体」「ポンプ・モータ一体型」などを選択。
    -   **L2 (モータ種別)**: L1の選択に応じて、「単相モータ」「三相モータ」などのサブオプションを表示。
    -   **L3 (モータ出力)**: L2の選択に応じて、モータの出力を選択。
        -   **選択状態の保持**: モータ種別（単相、三相など）を切り替える際、切り替え先のオプションに同じ出力値が存在すれば、その選択状態は保持されます。
    -   **L4 (詳細仕様)**: 型式が確定した後に表示されるオプション群。「用途」（標準/燃料油・クーラント用/液封仕様）の選択に加え、軸端形状、回転方向、シール材質、リリーフバルブなどを選択。
        -   **排他制御**: 「リリーフバルブ(VB)」と「回転方向(R)」は排他的関係にあり、同時選択はできません。一方が選択されると、もう一方は自動的にデフォルト値にリセットされます。
    -   オプション選択に応じて、製品画像が動的に更新される。

-   **性能グラフによる型式選定**:
    -   シリーズ選択時に、性能曲線グラフ（SVGで動的描画）を表示。
    -   グラフ内の領域をクリックすることで、具体的なポンプ型式を直感的に選択可能。

-   **リアルタイム型式表示**:
    -   画面下部のフッターに、選択中のオプションに基づいた製品型式をリアルタイムで組み立てて表示。
    -   未選択の項目はプレースホルダー（`□`）で示され、次に行うべき選択をユーザーに提示。

### 2.2. 詳細情報と高度な機能

-   **製品詳細表示**:
    -   型式が確定すると、寸法図面、仕様表、詳細な性能グラフ（流量特性・所要電力）を表示。
    -   仕様表と詳細性能グラフは、回転数（1500/1800 min⁻¹）をトグルボタンで切り替えることで、表示内容が連動して更新されます。
    -   詳細グラフは`Chart.js`ライブラリを使用し、選択中の型式がハイライト表示されます。

-   **型式一覧検索・選択モーダル**:
    -   フローティングボタンから、全製品の型式を一覧表示するモーダルを起動。
    -   製品カテゴリ、型式名（部分一致）、用途（標準/燃料油/液封）による高度な絞り込み検索機能。
    -   一覧上でホバーすると製品画像がプレビュー表示される。
    -   モーダルから型式を確定すると、その構成情報（シリーズ、製品構成、ポンプ型式、用途など）で`currentModel`オブジェクトが直接更新され、メイン画面のUI全体がその状態に同期される。

-   **3D/ARビューア**:
    -   `model-viewer`ライブラリを活用し、製品の3Dモデルをブラウザ上でインタラクティブに表示。
    -   寸法線の表示/非表示切り替えに対応。
    -   AR（拡張現実）機能を搭載。PCからはQRコードを生成し、スマートフォンで実空間に製品を投影可能。

### 2.3. 使用技術

-   **状態管理とUI同期**:
    -   **`currentModel`オブジェクト**: アプリケーションの状態（選択された製品シリーズ、オプション、型式、回転数など）を一元管理する単一のJSONオブジェクト。
    -   **イベント駆動のUI更新**: ユーザー操作により`currentModel`が更新され、それをトリガーに`updateUI()`関数がUI全体を再描画することで、状態と表示の一貫性を保つ一方向データフローを実現しています。
    -   **CSSクラスによる表示制御**: UIコンポーネントの表示・非表示は、JavaScriptで直接スタイル（`element.style.display`）を操作するのではなく、CSSクラス（例: `.show`, `.has-content`）の付け外しによって制御されます。これにより、状態管理（JavaScript）と見た目の定義（CSS）の関心事が明確に分離され、コードの可読性とメンテナンス性が向上しています。

-   **JavaScriptモジュールの役割**:
    -   `app.js`: アプリケーションの**中心的な役割**を担うファイル。エントリーポイント、API通信、状態管理の3つの機能を統合しています。`DOMContentLoaded`イベントを待ち、`productData.json`などの外部データを非同期で読み込み、ユーザーの選択状態を保持する`currentModel`オブジェクトを管理します。
    -   `ui.js`: UIの描画と更新を担当。HTMLの動的生成、DOM操作、UIコンポーネントの状態同期など、表示に関するロジックが集約されています。
    -   `events.js`: ユーザーからのすべてのインタラクション（クリック、入力など）を処理するイベントリスナーを管理します。`app.js` が管理する状態を更新し、`ui.js` の関数を呼び出してUIの変更をトリガーする司令塔の役割を担います。
    -   `chart.js`: グラフ描画に特化したモジュール。メインのSVG性能選定グラフと、`Chart.js`ライブラリを使用した詳細性能グラフの両方の描画・更新・破棄ロジックを管理します。

-   **フロントエンド**: HTML5, CSS3, JavaScript (ES6+)
-   **UIフレームワーク**: Tailwind CSS
-   **バックエンド (予定)**: Python, FastAPI
-   **ライブラリ**:
    -   `Chart.js`: 詳細性能グラフの描画
    -   `model-viewer`: 3DモデルおよびAR機能の実現
    -   `qrserver.com API`: AR誘導用のQRコード生成
    -   `Google Fonts`: UI全体のフォント（Inter）および、特定のデザイン要素（DotGothic16）に使用。

## 3. モダンなWEBカタログとしての展望

現在のアプリケーションは既に高機能ですが、より洗練されたモダンなWEBカタログへと進化させるため、以下の展望が考えられます。

### 3.1. 短期的な改善・拡張案

-   **状態管理の堅牢化**:
    -   URLに選択状態を反映させる（例: `?series=1A&l1=pump_only&model=100`）。これにより、ユーザーは選定途中の状態をブックマークしたり、他者と共有したりすることが可能になります。ページリロード時にも状態が復元され、利便性が大幅に向上します。

-   **データ管理の効率化**:
    -   製品データをバックエンド（FastAPI）経由で取得するように変更します。これにより、データの更新・メンテナンスが容易になり、将来的にはCMSやデータベースとの連携もスムーズに行えます。

-   **レスポンシブデザインの強化**:
    -   スマートフォンやタブレットでの操作性をさらに向上させるため、UIコンポーネントのレイアウトやサイズを最適化します。特に、複雑なオプション選択画面や詳細な仕様表を、小さな画面でも直感的に操作できるように改善します。

-   **パフォーマンス最適化**:
    -   製品画像の遅延読み込み（Lazy Loading）を実装し、初期表示速度を改善します。特に画像が多い製品で効果が期待できます。

### 3.2. 中長期的な展望

-   **比較機能の実装**:
    -   複数の候補モデルを選択し、仕様や性能グラフを横並びで比較できる機能を追加します。これにより、ユーザーは最終的な意思決定をより確信を持って行えるようになります。

-   **プロジェクト保存・見積依頼機能**:
    -   選定したモデル構成を「プロジェクト」として名前を付けて保存し、後から呼び出せるようにします（要ユーザー認証）。
    -   保存したプロジェクトから直接、PDF形式の仕様書を生成したり、ワンクリックで見積依頼を送信したりできるワークフローを構築します。

-   **スマートフォンカメラ連携による製品検索**:
    -   スマートフォンのカメラで撮影した既存のポンプの写真や動画から、AI画像認識を用いて類似モデルや後継機種を自動で検索・提案する機能を実装します。これにより、現場での型式確認やリプレース検討が劇的に簡素化されます。

-   **AR技術による高度な設置シミュレーション**:
    -   現在のAR表示機能を拡張し、スマートフォンのカメラ映像に実寸大の3Dモデルを重ねて表示するだけでなく、配管の接続位置や周辺機器との干渉チェックを行える高度な設置シミュレーション機能を目指します。

-   **コンポーネントベースへの移行**:
    -   React, Vue, SvelteなどのモダンなJavaScriptフレームワークを導入し、UIを再利用可能なコンポーネントとして再構築します。これにより、コードの可読性、保守性、拡張性が飛躍的に向上し、より複雑な機能追加にも柔軟に対応できるようになります。

-   **バックエンドとの連携強化**:
    -   在庫情報や価格、納期などをリアルタイムに表示するため、バックエンドAPIとの連携を強化します。これにより、単なるカタログツールから、販売に直結するECプラットフォームへと進化させることが可能です。

## 4. セキュリティに関する展望と方針

本プロジェクトを外部公開し、より高度な機能（AI連携など）を実装する上で、セキュリティの確保は最優先事項です。

### 4.1. データ隠蔽とアクセス制御

**課題**:
現状では、製品の全詳細データを含むJSONファイルをフロントエンドで直接読み込んでいるため、誰でも機密情報（詳細な性能数値など）を閲覧できてしまいます。

**方針**:
**バックエンドとしてFastAPIを導入**し、フロントエンドとデータの間にAPIを介在させます。

-   **データアクセスの抽象化**: フロントエンドは、詳細な製品データ構造を知る必要がなく、必要な情報をAPI経由でリクエストします（例: `GET /api/products/list`）。
-   **サーバーサイドでのデータ処理**: 型式確定後の詳細スペック取得などは、サーバーサイドでロジックを実行し、結果のみをフロントエンドに返します。これにより、生データやビジネスロジックの漏洩を防ぎます。
-   **段階的なアクセス制御**: 将来的には、ユーザー認証を導入し、ログインユーザーにのみ詳細なデータへのアクセスを許可する、といった制御も可能になります。

### 4.2. APIキーの安全な管理

**課題**:
将来的に生成AIなどの外部APIを利用する際、APIキーをフロントエンドに含めることは、キーの漏洩に繋がり非常に危険です。

**方針**:
**FastAPIで構築したバックエンドをプロキシサーバーとして機能させ、APIキーを秘匿化**します。

-   **APIキーの保管**: APIキーは、サーバーの**環境変数**（`.env`ファイルなど）にのみ保管し、Gitなどのバージョン管理システムには含めません。
-   **リクエストの代理実行**: フロントエンドは、自作のバックエンドAPI（例: `POST /api/ai/generate`）にリクエストを送信します。リクエストを受け取ったバックエンドが、安全に保管されたAPIキーを用いて外部APIを呼び出し、その結果をフロントエンドに返します。これにより、APIキーが外部に露出することを完全に防ぎます。